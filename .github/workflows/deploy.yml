# ‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á Workflow ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Actions ‡∏Ç‡∏≠‡∏á GitHub
name: Build and Deploy to Server

# ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô: ‡∏£‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£ push ‡πÑ‡∏õ‡∏ó‡∏µ‡πà branch 'main' ‡∏´‡∏£‡∏∑‡∏≠ 'develop'
on:
  push:
    branches:
      - main
      - develop

jobs:
  # Job ‡∏ó‡∏µ‡πà 1: Build ‡πÅ‡∏•‡∏∞ Push Docker Image
  build_and_push:
    runs-on: ubuntu-latest # ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ô‡∏ö‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á GitHub ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Ubuntu
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          # ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ Image ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ghcr.io/‡∏ä‡∏∑‡πà‡∏≠-user/‡∏ä‡∏∑‡πà‡∏≠-repo:sha-commit
          tags: ghcr.io/${{ github.repository }}:${{ github.sha }}

  # Job ‡∏ó‡∏µ‡πà 2: Deploy ‡πÑ‡∏õ‡∏¢‡∏±‡∏á DEV Server
  deploy_to_dev:
    needs: build_and_push # Job ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏£‡∏±‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠ 'build_and_push' ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    runs-on: ubuntu-latest
    # ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏£‡∏±‡∏ô Job ‡∏ô‡∏µ‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ event ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏µ‡πà branch 'develop' ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    if: github.ref == 'refs/heads/develop'
    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }} # IP ‡∏Ç‡∏≠‡∏á Server ‡∏à‡∏≤‡∏Å Secrets
          username: idtc
          key: ${{ secrets.SSH_PRIVATE_KEY }} # Private Key ‡∏à‡∏≤‡∏Å Secrets
          script: |
            set -e
            echo 'üöÄ Deploying to DEV Server'
            cd /srv/moodle/dev
            echo '1. Updating Image Tag in dev compose.yml'
            sed -i 's|image:.*|image: ghcr.io/${{ github.repository }}:${{ github.sha }}|g' compose.yml
            echo '2. Pulling the new image and restarting'
            docker compose pull
            docker compose up -d
            echo '‚úÖ Deployment to DEV finished!'

  # Job ‡∏ó‡∏µ‡πà 3: Deploy ‡πÑ‡∏õ‡∏¢‡∏±‡∏á QAS Server
  deploy_to_qas:
    needs: build_and_push
    runs-on: ubuntu-latest
    # ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏£‡∏±‡∏ô Job ‡∏ô‡∏µ‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ event ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏µ‡πà branch 'main' ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: idtc
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo 'üöÄ Deploying to QAS Server'
            cd /srv/moodle/qas
            echo '1. Updating Image Tag in qas compose.yml'
            sed -i 's|image:.*|image: ghcr.io/${{ github.repository }}:${{ github.sha }}|g' compose.yml
            echo '2. Pulling the new image and restarting'
            docker compose pull
            docker compose up -d
            echo '‚úÖ Deployment to QAS finished!'